name: Auto Renew Skybots

on:
  schedule:
    - cron: '0 0 */11 * *'  # 每11天运行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install selenium
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run renewal
        id: renew
        env:
          COOKIES: ${{ secrets.SKYBOTS_COOKIES }}
        run: |
          python - << 'EOF' | tee output.log
          import os, time
          from selenium import webdriver
          from selenium.webdriver.common.by import By
          from selenium.webdriver.chrome.options import Options

          options = Options()
          options.add_argument('--headless=new')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          
          driver = webdriver.Chrome(options=options)
          
          try:
              driver.get('https://skybots.tech')
              time.sleep(2)
              
              # 使用 CDP 设置 cookies
              driver.execute_cdp_cmd('Network.enable', {})
              for cookie in os.environ['COOKIES'].split('; '):
                  if '=' not in cookie:
                      continue
                  name, value = cookie.split('=', 1)
                  name = name.strip()
                  value = value.strip()
                  
                  # 构建 cookie 参数
                  cookie_param = {
                      'name': name,
                      'value': value,
                      'path': '/'
                  }
                  
                  # __Host- 前缀的 cookie 不能设置 domain
                  if '__Host-' in name:
                      cookie_param['secure'] = True
                      cookie_param['sameSite'] = 'None'
                      cookie_param['url'] = 'https://skybots.tech'
                  else:
                      cookie_param['domain'] = '.skybots.tech'
                      if '__Secure-' in name:
                          cookie_param['secure'] = True
                          cookie_param['sameSite'] = 'None'
                  
                  try:
                      driver.execute_cdp_cmd('Network.setCookie', cookie_param)
                  except Exception as e:
                      print(f'⚠️ 跳过 {name}: {str(e)[:50]}')
              
              driver.get('https://skybots.tech/dashboard/my-projects')
              time.sleep(5)
              
              # 检查登录状态
              if 'discord' in driver.current_url.lower():
                  print('❌ Cookie 已过期')
                  exit(1)
              
              driver.save_screenshot('page.png')
              
              # 查找并点击续期按钮
              buttons = driver.find_elements(By.XPATH, "//button[contains(., 'Renouveler')]")
              if buttons:
                  print(f'找到续期按钮')
                  driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", buttons[0])
                  time.sleep(1)
                  driver.execute_script("arguments[0].click();", buttons[0])
                  time.sleep(2)
                  
                  # 处理成功提示
                  try:
                      alert = driver.switch_to.alert
                      print(f'✅ {alert.text}')
                      alert.accept()
                  except:
                      pass
                  
                  # 输出新 cookies
                  cookies = '; '.join([f"{c['name']}={c['value']}" for c in driver.get_cookies()])
                  print(f'NEW_COOKIES={cookies}')
              else:
                  print('✅ 无需续期')
              
          finally:
              driver.quit()
          EOF

      - name: Update cookies
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # 提取新的 cookies
          new_cookies=$(grep "NEW_COOKIES=" output.log | cut -d'=' -f2-)
          
          if [ -n "$new_cookies" ]; then
            echo "正在更新 Secrets..."
            gh secret set SKYBOTS_COOKIES --body "$new_cookies"
            echo "✅ Cookies 已更新"
          else
            echo "ℹ️ 无需更新 Cookies"
          fi

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: page.png
          if-no-files-found: ignore
