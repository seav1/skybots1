name: Auto Renew Skybots

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ (UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install selenium
          # ä¿æŒæ‰‹åŠ¨å®‰è£… Chrome ä»¥ç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb

      - name: Run renewal
        id: renew
        env:
          COOKIES: ${{ secrets.SKYBOTS_COOKIES }}
        run: |
          # ä½¿ç”¨ > output.log å°†æ ‡å‡†è¾“å‡º(stdout)é‡å®šå‘åˆ°æ–‡ä»¶
          # ä½¿ç”¨ sys.stderr å°†æ—¥å¿—è¾“å‡ºåˆ°å±å¹•ï¼Œç¡®ä¿èƒ½çœ‹åˆ°ç»­æœŸç»“æœ
          python - << 'EOF' > output.log
          import os
          import time
          import json
          import sys
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options

          # é…ç½®
          DASHBOARD_URL = 'https://dash.skybots.tech/dashboard/my-projects'
          API_RENEW_URL = 'https://dash.skybots.tech/api/v1/bots?action=renew'
          
          # è·å–ç¯å¢ƒå˜é‡
          cookies_env = os.environ.get('COOKIES', '')

          # è®¾ç½® Chrome é€‰é¡¹
          options = Options()
          options.add_argument('--headless=new')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          options.add_argument('--window-size=1920,1080')
          options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36')

          driver = webdriver.Chrome(options=options)
          
          def log(msg):
              # å†™å…¥æ–‡ä»¶ (å› ä¸º stdout è¢«é‡å®šå‘äº†)
              print(f"[Skybots] {msg}")
              # å†™å…¥å±å¹• (stderr ä¸ä¼šè¢«é‡å®šå‘ï¼Œèƒ½åœ¨ Action æ—¥å¿—ä¸­çœ‹åˆ°)
              sys.stderr.write(f"[Skybots] {msg}\n")
              sys.stderr.flush()

          try:
              log("åˆå§‹åŒ–æµè§ˆå™¨...")
              driver.get('https://skybots.tech')
              time.sleep(2)

              # -------------------------------------------------
              # 1. æ³¨å…¥ Cookies
              # -------------------------------------------------
              log("æ³¨å…¥ Cookies...")
              driver.execute_cdp_cmd('Network.enable', {})
              
              if not cookies_env:
                  raise Exception("Secrets ä¸­æœªæ‰¾åˆ° COOKIES")

              for cookie in cookies_env.split('; '):
                  if '=' not in cookie: continue
                  name, value = cookie.split('=', 1)
                  cookie_param = {
                      'name': name.strip(),
                      'value': value.strip(),
                      'path': '/',
                      'secure': True
                  }
                  
                  if '__Host-' in name:
                      cookie_param['url'] = 'https://skybots.tech'
                  else:
                      cookie_param['domain'] = '.skybots.tech'

                  try:
                      driver.execute_cdp_cmd('Network.setCookie', cookie_param)
                  except:
                      pass

              # -------------------------------------------------
              # 2. è®¿é—®æ§åˆ¶å°æ¿€æ´» Session
              # -------------------------------------------------
              log(f"è®¿é—®æ§åˆ¶å°: {DASHBOARD_URL}")
              driver.get(DASHBOARD_URL)
              time.sleep(5) 
              
              if 'login' in driver.current_url.lower():
                  log("âŒ Cookie å·²å¤±æ•ˆï¼Œé‡å®šå‘åˆ°äº†ç™»å½•é¡µ")
                  exit(1)
              
              # -------------------------------------------------
              # 3. API è·å– ID åˆ—è¡¨ (æ— éœ€æ­£åˆ™ï¼Œç›´æ¥è°ƒç”¨æ¥å£)
              # -------------------------------------------------
              log("å°è¯•é€šè¿‡ API è·å– Bot åˆ—è¡¨...")
              found_ids = []
              
              get_bots_script = """
              var callback = arguments[0];
              fetch('/api/v1/bots')
                  .then(response => response.json())
                  .then(data => {
                      // å…¼å®¹ä¸åŒçš„æ•°æ®ç»“æ„è¿”å›
                      var list = Array.isArray(data) ? data : (data.data || data.bots || []);
                      var ids = list.map(item => item.id || item.botId || item._id).filter(id => id);
                      callback(JSON.stringify(ids));
                  })
                  .catch(err => callback("ERROR: " + err));
              """
              
              try:
                  api_result = driver.execute_async_script(get_bots_script)
                  if "ERROR" in str(api_result):
                      log(f"âŒ API è·å–åˆ—è¡¨å¤±è´¥: {api_result}")
                  else:
                      found_ids = json.loads(api_result)
                      log(f"âœ… API è¿”å›çš„ ID åˆ—è¡¨: {found_ids}")
              except Exception as e:
                  log(f"âŒ æ‰§è¡Œ API è„šæœ¬å‡ºé”™: {e}")

              if not found_ids:
                  log("âŒ æœªæ‰¾åˆ°ä»»ä½• Bot IDï¼Œæ— æ³•ç»­æœŸã€‚")
                  exit(1)

              # -------------------------------------------------
              # 4. æ‰§è¡Œ API ç»­æœŸ
              # -------------------------------------------------
              for bot_id in found_ids:
                  log(f"ğŸš€ æ­£åœ¨ç»­æœŸ Bot: {bot_id}")
                  
                  renew_script = f"""
                  var callback = arguments[0];
                  fetch('{API_RENEW_URL}', {{
                      method: 'POST',
                      headers: {{ 'Content-Type': 'application/json' }},
                      body: JSON.stringify({{botId: '{bot_id}'}})
                  }})
                  .then(r => r.text())
                  .then(t => callback(t))
                  .catch(e => callback("ERROR: " + e));
                  """
                  
                  try:
                      result = driver.execute_async_script(renew_script)
                      log(f"API å“åº”: {result}")
                  except Exception as e:
                      log(f"âŒ è°ƒç”¨å¤±è´¥: {e}")
                  
                  time.sleep(2)

              # è¾“å‡ºæ–° Cookies (åªç”¨ printï¼Œè¿™æ ·åªå»æ–‡ä»¶ï¼Œä¸æ˜¾ç¤ºåœ¨å±å¹•é˜²æ­¢åˆ·å±)
              cookies = '; '.join([f"{c['name']}={c['value']}" for c in driver.get_cookies()])
              print(f'NEW_COOKIES={cookies}')

          except Exception as e:
              log(f"âŒ é”™è¯¯: {str(e)}")
              driver.save_screenshot('error.png')
              exit(1)
          finally:
              driver.quit()
          EOF

      - name: Update cookies
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          new_cookies=$(grep "NEW_COOKIES=" output.log | cut -d'=' -f2-)
          if [ -n "$new_cookies" ]; then
            echo "æ­£åœ¨æ›´æ–° Secrets..."
            gh secret set SKYBOTS_COOKIES --repo "$REPO" --body "$new_cookies"
            echo "âœ… Cookies å·²æ›´æ–°"
          else
            echo "â„¹ï¸ æ— éœ€æ›´æ–° Cookies"
          fi
          
      - name: Upload screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot
          path: error.png
